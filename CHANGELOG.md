# 更新日志

本文档记录了项目的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
项目遵循 [语义化版本](https://semver.org/lang/zh-CN/spec/v2.0.0.html) 规范。

## [未发布] - 2025-01-08

### ✨ 新增功能

#### 用户资料管理
- **完整的个人资料页面**：展示用户的所有信息，包括基本信息、联系方式和账户状态
- **资料编辑功能**：支持在线编辑姓名、中文姓名、别名、手机号和额外信息
- **实时数据更新**：保存后立即更新显示，无需刷新页面
- **表单验证**：使用 Zod 进行客户端和服务端双重验证
- **手机号唯一性检查**：防止重复绑定手机号

#### 数据库扩展
- **新增用户字段**：
  - `phone` - 手机号（唯一约束）
  - `cn_name` - 中文姓名
  - `alas` - 别名
  - `extra` - JSON 格式的额外信息（默认为空对象）
- **数据库迁移**：自动创建迁移文件并应用到数据库

#### API 端点
- **GET /api/user/profile**：获取当前用户的完整资料
- **PATCH /api/user/profile**：更新用户资料信息
- **完善的错误处理**：返回清晰的错误信息和适当的 HTTP 状态码
- **身份验证**：使用 Better Auth 进行会话验证

#### 用户界面优化
- **账户状态可视化**：使用颜色和图标标记已完成/未完成的信息项
  - 绿色徽章（主题色）- 已完成项
  - 灰色徽章 - 未完成项
  - 红色徽章 - 邮箱未验证（重要提示）
- **语义化图标**：为每个状态项添加 Lucide 图标
  - CheckCircle2/XCircle - 邮箱验证状态
  - ImageIcon - 头像
  - Phone - 手机号
  - UserCircle - 中文姓名
  - Tag - 别名
  - FileJson - 额外信息
- **侧边栏图标优化**：使用 Contact 图标替代自定义绘制的方块

#### 侧边栏增强
- **个人资料菜单**：在用户菜单中添加"个人资料"入口
- **退出登录优化**：将"登出"改为"退出登录"，语义更清晰
- **菜单分隔线**：使用分隔线区分不同功能区域

### 🔧 改进优化

#### 代码架构
- **类型定义集中管理**：
  - 创建 `ui/types/profile.ts` 存放资料验证 schema
  - 创建 `ui/types/user.ts` 存放用户相关类型
- **使用 Prisma 生成类型**：直接使用 Prisma Client 生成的类型，避免重复定义
- **模块化设计**：将验证逻辑、类型定义和业务逻辑分离

#### 用户体验
- **加载状态提示**：数据获取时显示"加载中..."
- **日期格式化**：自动处理 API 返回的字符串日期
- **表单状态管理**：编辑时保留原始数据，取消时恢复
- **友好的错误提示**：使用 toast 显示操作结果

#### 性能优化
- **按需数据获取**：仅在需要时从 API 获取完整用户数据
- **避免不必要的刷新**：更新后直接更新本地状态，不刷新页面
- **Prisma 客户端优化**：使用 select 仅查询需要的字段

### 🐛 问题修复

#### 数据库相关
- **Prisma 客户端同步**：修复 schema 更新后客户端未识别新字段的问题
- **唯一约束处理**：正确处理 phone 字段的唯一约束错误
- **空值处理**：正确处理空字符串转 null 的逻辑

#### 类型安全
- **修复 TypeScript 错误**：
  - 修复 `z.record` 参数数量错误
  - 修复 Prisma 类型导入路径
  - 修复日期类型处理
- **移除 any 类型**：使用正确的类型定义替代 any

#### UI 问题
- **日期显示错误**：修复 `toLocaleDateString` 在字符串上调用的错误
- **数据不显示**：修复 Profile 页面无法显示数据库新字段的问题

### 🔒 安全性

- **输入验证**：所有用户输入都经过 Zod schema 验证
- **SQL 注入防护**：使用 Prisma ORM 的参数化查询
- **会话验证**：所有 API 端点都进行身份验证
- **数据清理**：自动清理和标准化用户输入（trim、null 转换）

### 📚 技术细节

#### 数据库 Schema
```prisma
model User {
  phone         String?   // 新增：手机号（唯一）
  cn_name       String?   // 新增：中文姓名
  alas          String?   // 新增：别名
  extra         Json      @default("{}") // 新增：额外信息
  
  @@unique([phone])
}
```

#### API 设计
- RESTful 风格：GET 获取、PATCH 更新
- 标准 HTTP 状态码：200、400、401、404、409、500
- 统一错误响应格式
- 类型安全的请求/响应

#### 依赖项
- 使用 Prisma 7.2.0 生成类型安全的数据库客户端
- 使用 Zod 进行运行时类型验证
- 使用 Lucide React 提供图标组件

---

## [0.2.0] - 2025-01-07

### ✨ 新增功能

#### 主题系统
- **8 款精美配色主题**：可选择紫罗兰绽、日落余晖、Supabase、粘土形态、自然翠绿、海洋微风、量子玫瑰、禅意花园
- **亮暗模式切换**：在亮色和暗色模式之间无缝切换，即时视觉反馈
- **主题持久化**：自动保存并恢复您的主题偏好设置
- **平滑主题过渡**：智能过渡系统防止主题切换时的视觉闪烁

#### 侧边栏导航
- **响应式侧边栏**：可折叠侧边栏，自适应移动端和桌面端屏幕
- **用户信息区**：显示用户头像、姓名和邮箱
- **菜单组织**：支持可折叠子菜单的层级导航
- **快捷设置入口**：便捷访问主题控制和文档链接
- **主题感知样式**：侧边栏颜色自动适配所选主题和模式

#### 认证界面
- **表单验证**：使用 Zod 模式进行注册和登录表单的客户端验证
- **友好的错误提示**：为验证错误提供清晰的反馈信息
- **安全的输入处理**：密码字段支持可见性切换

### 🔧 改进优化

#### 性能提升
- **优化主题切换**：通过临时禁用 CSS 过渡消除主题切换时的闪烁
- **减少 Hydration 不匹配**：改进主题组件的服务端渲染兼容性
- **高效状态管理**：优化主题和侧边栏控制的 React 状态更新

#### 用户体验
- **即时主题应用**：主题现在可以立即应用，无视觉瑕疵
- **一致的配色方案**：所有 UI 组件通过 CSS 变量正确继承主题颜色
- **更好的移动体验**：移动端侧边栏转换为滑出式抽屉
- **键盘快捷键**：按 Cmd/Ctrl+B 切换侧边栏显示

#### 代码质量
- **类型安全**：主题系统和组件完全支持 TypeScript
- **CSS 架构**：使用 OKLch 色彩空间组织主题变量，确保颜色一致性
- **组件模块化**：将主题逻辑分离为可复用的 hooks 和组件
- **文档完善**：为主题系统添加了全面的技术文档

### 🐛 问题修复

#### 主题系统
- **侧边栏闪烁**：解决了在亮暗模式切换时的视觉闪烁问题
- **缺失的主题变量**：为所有 8 个主题添加了完整的侧边栏颜色变量
- **Hydration 警告**：修复了主题组件中的 React hydration 不匹配
- **CSS 过渡冲突**：移除了导致不必要动画的全局 CSS 过渡

#### 样式问题
- **侧边栏颜色应用**：确保侧边栏在亮暗模式下正确应用主题特定颜色
- **边框一致性**：修复了不同主题间边框颜色不一致的问题
- **焦点环可见性**：改进焦点指示器的可见性，提升无障碍访问

### 🔒 安全性

- **输入清理**：添加 Zod 验证以防止提交格式错误的数据
- **XSS 防护**：对表单中的用户生成内容进行适当转义

### 📚 技术细节

#### 架构变更
- 实现 `.theme-transitioning` CSS 类来控制过渡行为
- 添加 `requestAnimationFrame` 时序以实现平滑的 DOM 更新
- 集成 Tailwind CSS 4 的 `@theme inline` 进行变量映射
- 创建自定义 hooks（`useColorTheme`）用于主题状态管理

#### 依赖项
- 添加 `next-themes` 用于亮暗模式管理
- 集成 `@radix-ui` 组件以实现无障碍 UI 原语
- 配置 Zod 进行运行时类型验证

---

## [0.1.0] - 2025-01-02

### ✨ 新增功能

- 使用 Next.js 15 初始化项目
- 基于 Better Auth 的基础认证系统
- Prisma ORM 与 PostgreSQL 集成
- 用户注册和登录功能
- 仪表板布局结构

---

## 说明

### 破坏性变更
本次发布无破坏性变更。

### 迁移指南
无需迁移。所有变更向后兼容。

### 已知问题
- 主题选择器在极小屏幕（<320px）上可能显示不正确
- 某些第三方组件可能无法完全遵循主题颜色

### 即将推出
- 自定义主题创建器
- 主题导入/导出功能
- 更细粒度的主题自定义选项
- 高对比度模式的无障碍改进

---
